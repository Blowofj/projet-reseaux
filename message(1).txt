# üñ•Ô∏è Projet Infrastructure Linux Multi-Serveurs

Infrastructure multi-serveurs haute disponibilit√© sous Ubuntu 24.04 LTS avec automatisation compl√®te via Terraform, Ansible et Docker.

## üìã Table des mati√®res

- [Vue d'ensemble](#vue-densemble)
- [Architecture](#architecture)
- [Stack technique](#stack-technique)
- [Services d√©ploy√©s](#services-d√©ploy√©s)
- [Syst√®me de backup](#syst√®me-de-backup)
- [Installation et d√©ploiement](#installation-et-d√©ploiement)
- [Am√©liorations futures](#am√©liorations-futures)

## üéØ Vue d'ensemble

Infrastructure multi-sites con√ßue pour assurer **haute disponibilit√©**, **s√©curit√©** et **automatisation** des services. L'ensemble de l'infrastructure peut √™tre recr√©√©e en une seule commande gr√¢ce √† l'Infrastructure as Code (IaC).

### Objectifs du projet

- ‚úÖ Automatisation compl√®te du d√©ploiement
- ‚úÖ S√©curit√© renforc√©e via architecture bastion
- ‚úÖ Sauvegarde multi-sites avec BorgBackup
- ‚úÖ Monitoring temps r√©el des services
- ‚úÖ Gestion centralis√©e des conteneurs Docker

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    BASTION      ‚îÇ  Couche de s√©curit√©
‚îÇ  (Entry Point)  ‚îÇ  - Terraform
‚îÇ                 ‚îÇ  - Ansible
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  - doctl
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇSite A ‚îÇ ‚îÇSite B ‚îÇ
‚îÇDocker ‚îÇ ‚îÇBackup ‚îÇ
‚îÇStack  ‚îÇ ‚îÇServer ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Serveurs

| Serveur | R√¥le | Description |
|---------|------|-------------|
| **Bastion** | Point d'entr√©e s√©curis√© | Centralise les acc√®s, g√®re les cl√©s SSH, orchestre le d√©ploiement |
| **Site A** | Serveur applicatif | H√©berge tous les conteneurs Docker des services |
| **Site B** | Serveur de backup | R√©ceptionne et stocke les sauvegardes distantes |

> **Note de s√©curit√©** : Les sites A et B ne sont pas expos√©s directement. Tous les acc√®s passent par le bastion.

## üõ†Ô∏è Stack technique

### Infrastructure as Code (Bastion)

| Outil | Usage | Avantage |
|-------|-------|----------|
| **Terraform** | Provisionnement serveurs Digital Ocean | Infrastructure reproductible en une commande |
| **Ansible** | Configuration automatique des serveurs | D√©ploiement coh√©rent et versionn√© |
| **doctl** | CLI Digital Ocean | Gestion programmatique des ressources cloud |

### Conteneurisation (Site A)

- **Docker** : Isolation des services, d√©ploiement simplifi√©
- **Nginx Proxy Manager** : Gestion des certificats SSL et reverse proxy
- **Future** : Migration vers Docker Swarm pour haute disponibilit√© et auto-healing

## üì¶ Services d√©ploy√©s

### üåê Service principal

#### WordPress
- **Description** : Site web principal
- **Choix** : Popularit√©, facilit√© d'utilisation, √©cosyst√®me riche
- **Base de donn√©es** : MariaDB
- **Interface admin** : PhpMyAdmin

**Identifiants PhpMyAdmin** :
```
Serveur : wordpress-db
Utilisateur : wordpress
Mot de passe : wordpress_password
```

### üìä Monitoring

| Service | Description | Acc√®s |
|---------|-------------|-------|
| **Zabbix** | Collecte m√©triques syst√®me d√©taill√©es | Interface web |
| **Uptime Kuma** | Surveillance HTTP/ping des services | [https://uptime.7guys1girl.fr/status/7guys-status](https://uptime.7guys1girl.fr/status/7guys-status)<br>User: `wheelroot` |
| **Dozzle** | Logs temps r√©el de tous les conteneurs | Interface web |

### üéõÔ∏è Gestion et administration

| Service | Description | Avantages |
|---------|-------------|-----------|
| **Portainer** | Interface web de gestion Docker | Contr√¥le visuel des conteneurs (start/stop/restart) |
| **Homer** | Dashboard centralis√© | Acc√®s rapide √† tous les services depuis une page unique |

## üíæ Syst√®me de backup

### BorgBackup - Sauvegarde incr√©mentale chiffr√©e

**Principe** : Snapshots incr√©mentaux avec d√©duplication automatique

#### Configuration initiale

```bash
# Connexion au serveur de backup (Site B)
ssh -i ~/.ssh/terraform_key root@138.68.162.7

# Initialisation du d√©p√¥t Borg
mkdir -p /backups/siteA-borg
borg init --encryption=repokey /backups/siteA-borg
```

#### Script de backup automatique

```bash
#!/bin/bash
set -e

# Configuration du d√©p√¥t Borg
export BORG_REPO="ssh://root@138.68.162.7:22/backups/siteA-borg"
export BORG_PASSPHRASE="7guys1girlCucked"
export BORG_RSH="ssh -i ~/.ssh/terraform_key"

# Cr√©ation du backup
borg create \
    --stats \
    --progress \
    --compression zstd,10 \
    --exclude-caches \
    --exclude '/dev/*' \
    --exclude '/proc/*' \
    --exclude '/sys/*' \
    --exclude '/tmp/*' \
    --exclude '/run/*' \
    --exclude '/mnt/*' \
    --exclude '/media/*' \
    --exclude '/lost+found' \
    --exclude '/var/cache/*' \
    --exclude '/var/tmp/*' \
    --exclude '/var/log/journal/*' \
    --exclude '*.log' \
    --exclude '/swapfile' \
    --exclude '/swap.img' \
    ${BORG_REPO}::site-a-full-{now:%Y-%m-%d_%H-%M-%S} \
    /

# Politique de r√©tention
borg prune -v \
    --keep-daily=7 \
    --keep-weekly=4 \
    --keep-monthly=6
```

#### Planification automatique

```bash
# Cron : Backup quotidien √† 2h00
0 2 * * * /root/scripts/backup.sh

# Backup hebdomadaire Digital Ocean (snapshot)
```

#### Lister les backups disponibles

```bash
borg list

# Exemple de sortie :
# backup-2025-12-17                    Wed, 2025-12-17 00:34:35
# backup-2025-12-17-0130               Wed, 2025-12-17 01:30:14
# backup-2025-12-17-0200               Wed, 2025-12-17 02:00:21
```

### üîÑ Restauration d'urgence

Pour restaurer un serveur complet en cas de sinistre :

```bash
cd /
borg extract ssh://root@165.227.140.157/root/backups/site-a::site-a-full-2025-12-17_03-00-00
```

> ‚ö†Ô∏è **Attention** : Cette commande √©crase tout le syst√®me. √Ä utiliser uniquement en cas d'urgence.

### Caract√©ristiques BorgBackup

- ‚úÖ **Snapshots ind√©pendants** : Chaque backup est restaurable individuellement
- ‚úÖ **D√©duplication** : Seules les diff√©rences sont stock√©es
- ‚úÖ **Compression** : zstd niveau 10 pour un ratio optimal
- ‚úÖ **Chiffrement** : Protection des donn√©es avec repokey
- ‚úÖ **R√©tention automatique** : 7 jours + 4 semaines + 6 mois

## üöÄ Installation et d√©ploiement

### Pr√©requis

- Compte Digital Ocean avec cl√© API
- Cl√©s SSH configur√©es
- Ubuntu 24.04 LTS

### D√©ploiement complet

```bash
# 1. Sur le bastion, initialiser l'infrastructure
terraform init
terraform plan
terraform apply

# 2. Configuration automatique via Ansible
ansible-playbook -i inventory/hosts.yml playbooks/setup.yml

# 3. D√©ploiement des conteneurs
ansible-playbook -i inventory/hosts.yml playbooks/deploy-docker.yml
```

### Acc√®s aux services

Tous les services sont accessibles via le bastion. Configurez votre SSH pour rebondir :

```bash
# ~/.ssh/config
Host bastion
    HostName <BASTION_IP>
    User root
    IdentityFile ~/.ssh/terraform_key

Host site-a
    HostName <SITE_A_PRIVATE_IP>
    User root
    ProxyJump bastion
    IdentityFile ~/.ssh/terraform_key
```

## üîÆ Am√©liorations futures

### Priorit√© haute

- [ ] **Migration Docker Swarm** : Auto-healing et haute disponibilit√© native
- [ ] **Strat√©gie backup 3-2-1** : 3 copies, 2 supports diff√©rents, 1 hors ligne
  - Ajout d'un stockage cloud (AWS S3/Backblaze B2)
  - Conservation des snapshots Digital Ocean actuels
- [ ] **VPN d'infrastructure** : Cr√©er un intranet s√©curis√©
  - Seul WordPress accessible publiquement
  - Tous les services admin via VPN uniquement

### S√©curit√©

- [ ] **Lynis** : Scanner de s√©curit√© syst√®me
- [ ] **Durcissement** : R√©vision des permissions utilisateurs
- [ ] **Fail2Ban** : Protection contre les attaques brute-force
- [ ] **WAF** : Web Application Firewall devant WordPress

### Monitoring et alertes

- [ ] **Alertes temps r√©el** : Notifications Discord/Email/SMS
  - Int√©gration Uptime Kuma avec webhooks
  - Alertes Zabbix pour m√©triques critiques
- [ ] **Logging centralis√©** : Stack ELK ou Loki
- [ ] **M√©triques applicatives** : Prometheus + Grafana

### Documentation

- [ ] **Disaster Recovery Plan** : Proc√©dures compl√®tes de restauration
- [ ] **Runbooks** : Documentation des incidents connus
- [ ] **Architecture Decision Records** : Historique des choix techniques

## üìù Notes

### S√©curit√©

- Les credentials affich√©s dans ce README sont des exemples
- En production, utilisez des secrets managers (Vault, Ansible Vault)
- Changez tous les mots de passe par d√©faut

### Performance

- Compression Borg zstd,10 : √âquilibre entre taille et vitesse
- Monitoring continu pour identifier les bottlenecks
- Optimisation WordPress : Cache, CDN, optimisation BDD

## ü§ù Contribution

Projet r√©alis√© dans le cadre d'une infrastructure d'apprentissage Linux.

---

**√âquipe** : 7guys1girl  
**OS** : Ubuntu 24.04 LTS  
**Cloud Provider** : Digital Ocean  
**Date** : D√©cembre 2025